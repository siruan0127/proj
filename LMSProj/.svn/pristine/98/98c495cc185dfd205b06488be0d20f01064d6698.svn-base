<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@page import="java.text.SimpleDateFormat"%>
<%@page import="java.util.Date"%>
<script type="text/javascript" src="/resources/js/jquery-3.6.0.js"></script>
<script type="text/javascript" src="/resources/js/mail.js"></script>
<style type="text/css">
	.btn-group{
		position : relative;
		top: 40px;
	}
	.email-list>li .email-content .email-date{
		width: 200px;
	}
	
	.read{
		font-size: 20px;
	}
	
	.clip{
		font-size: 17px;
	}
	
	.email-title{
		padding-left: 10px;
	}
	
	.email-list>li:hover .email-content .email-date{
		opacity: 100;
	}
	
	.email-list>li:hover {
	    background: #f1f3fa !important;
	    transition-duration: .05s;
    }
    
    .mailList{
    	min-height : 760px;
    }
    .email-list{
    	padding-top : 50px;
    }
</style>
<script type="text/javascript" defer="defer">
$(function() {
		$("#mailAll").on('click', function() {
			chk = [];
			 $("input[name=chk]:checked").each(function(){
				 chk.push($(this).data('read'));
			 });
			 
			if(chk[0] == "Y"){
				$('#readBtn').html("안읽음");
			}
			
			for(var i = 0; i < chk.length - 1; i++){
				if(chk[0] != chk[i]){
					$('#readBtn').html("읽음");
				}else{
					$('#readBtn').html("안읽음");
				}
			}
			
			if($("#mailAll").is(":checked")){
				$('input[name=chk]').prop("checked", true);
				$('.email-list>li').css('background', '#f1f3fa');
			}else{
				$("input[name=chk]").prop("checked", false);
				$(".email-list>li").css('background', 'none');
			}
		});
		
		$("input[name=chk]").on('click', function() {
			var total = $("input[name=chk]").length;
			var checked = $("input[name=chk]:checked").length;
			
			if(total != checked) $("#mailAll").prop("checked", false);
			else $("#mailAll").prop("checked", true); 
			
			if($(this).is(":checked")){
				$('li_'+$(this).val()).css('background', '#f1f3fa');
			}else{
				$('li_'+$(this).val()).css('background', 'none');
			}
			
			chk = [];
			 $("input[name=chk]:checked").each(function(){
				 chk.push($(this).data('read'));
			 });
			 
			if(chk[0] == "Y"){
				$('#readBtn').html("안읽음");
			}else{
				$('#readBtn').html("읽음");
			}
			
			for(var i = 1; i < chk.length; i++){
				if(chk[0] != chk[i]){
					$('#readBtn').html("읽음");
				}
			}
			
		});
		
		$('#delBtn').on('click', function(){
// 			alert("delBtn");
			if(!confirm("정말 삭제하시겠습니까?")){
				return false;
			}
			
			chkVal = [];
			$('input[name=chk]:checked').each(function(i){
				chkVal.push($(this).val());
			});
			
// 			alert(chkVal);
			
			console.log(JSON.stringify(chkVal));
			
			deleteAll(chkVal);
		});
		
		$('#readBtn').on('click', function(){
// 			alert("readBtn");
			
			chkVal = [];
			$('input[name=chk]:checked').each(function(i){
				if(document.querySelector("#mlcd_"+$(this).val()).dataset.senrcp == 0){
					chkVal.push($(this).val());
				}
			});
			
// 			alert(chkVal);
			
			readBtnTxt = $(this).text();
// 			alert(readBtnTxt);
			let data = "";
			
			if(readBtnTxt == "안읽음"){
				data = { 'chkVal' : chkVal, "mlYn" : 0 };
				for(var i=0; i < chkVal.length; i++){
					mlCd = chkVal[i];
					$('#mlcd_' + mlCd).attr('class', 'mdi mdi-email read');
// 					console.log(document.querySelector("#mlcd_"+mlCd).dataset);
					document.querySelector("#mlcd_"+mlCd).dataset.read = "N"
					$('#li_' + mlCd).attr('class', 'unread');
				};
				
				$('#readBtn').html("읽음");
			}else{
				data = { 'chkVal' : chkVal, "mlYn" : 1 };
				for(var i=0; i < chkVal.length; i++){
					mlCd = chkVal[i];
					$('#mlcd_' + mlCd).attr('class', 'mdi mdi-email-open read');
// 					console.log(document.querySelector("#mlcd_"+mlCd).dataset);
					document.querySelector("#mlcd_"+mlCd).dataset.read = "Y"
					$('#li_' + mlCd).attr('class', '');
				};
				
				$('#readBtn').html("안읽음");
			}
			
			updateYN(data);
		});
		
		
		$('.read').on('click', function(){
			var mlCd = $(this).attr('id');
// 			alert(mlCd)
// 			var read = $('#' + mlCd).data("read");
			console.log("chk1",document.querySelector("#"+mlCd));
			console.log("chk2",document.querySelector("#"+mlCd).dataset);
			
			var read = document.querySelector("#"+mlCd).dataset.read;
// 			alert(read);
// 			alert("$(this).data('senrcp')" + $(this).data('senrcp'));
			if(document.querySelector("#"+mlCd).dataset.senrcp == 1){
				return false;
			}
			
			
			chkVal = [];
			
			if(read == 'Y'){
// 				alert("y");
				$('#' + mlCd).attr('class', 'mdi mdi-email read');
				//$('#' + mlCd).attr("data-read", "N");
				console.log("chk3",document.querySelector("#"+mlCd));
				console.log("chk4",document.querySelector("#"+mlCd).dataset);
				document.querySelector("#"+mlCd).dataset.read = "N";

				mlCd = mlCd.substring(mlCd.indexOf('_') + 1, mlCd.length)
				console.log("mlCd", mlCd);
				
				chkVal.push(mlCd);
				
				$('#li_' + mlCd).attr('class', 'unread');
				
				var data = {
								"chkVal" : chkVal,
								"mlYn" : 0
							};
				
				updateYN(data);
			}else{
// 				alert("n");
				$('#' + mlCd).attr('class', 'mdi mdi-email-open read');
				document.querySelector("#"+mlCd).dataset.read = "Y";

				mlCd = mlCd.substring(mlCd.indexOf('_') + 1, mlCd.length)
				console.log("mlCd", mlCd);
				
				$('#li_' + mlCd).attr('class', '');
				chkVal.push(mlCd);
				
				var data = {
								"chkVal" : chkVal,
								"mlYn" : 1
							};
				
				updateYN(data);
			}
		});
	});
</script>
<%
	Date date = new Date();
	SimpleDateFormat simpleDate = new SimpleDateFormat("yyyy-MM-dd");
	String simDate = simpleDate.format(date);
%>
<div style="width: 100%;background: #fff;padding: 2%;">
	<div style="width: 100%; min-width: 1200px; max-width: 1575px; margin: 0 auto;">
		<div class="app-search dropdown d-none d-lg-block" style="width: 300px;">
		    <form method="get" action="/mail/mailAll">
		        <div class="input-group">
		            <input type="text" class="form-control dropdown-toggle" placeholder="Search..." id="top-search" name="keyword" value="${ map.keyword }">
		            <span class="mdi mdi-magnify search-icon"></span>
		            <div class="input-group-append">
		                <button class="btn btn-primary" type="submit">Search</button>
		            </div>
		        </div>
		
		    </form>
		</div>
		<br>
		<div class="btn-group">
			<div class="custom-control custom-checkbox">
				<input type="checkbox" class="custom-control-input" id="mailAll">
				<label class="custom-control-label" for="mailAll"></label>
			</div>
			<button type="button" class="btn btn-secondary btn-sm" id="readBtn">읽음</button>
			<button type="button" class="btn btn-secondary btn-sm" id="delBtn">삭제</button>
		</div>
		<c:set var="date" value="<%= simDate %>" />
		<div class="mt-3 mailList">
			<ul class="email-list">
				<c:forEach var="mailVO" items="${ list.content }">
					<fmt:formatDate var="mlTm" value='${ mailVO.mlTm }' pattern='yyyy-MM-dd' />
					<c:if test="${ mailVO.mlYn == 0 and mailVO.senRcp == 0 }">
						<li class="unread" id="li_${ mailVO.mlCd }">
							<div class="email-sender-info">
								<div class="checkbox-wrapper-mail">
									<div class="custom-control custom-checkbox">
										<input type="checkbox" class="custom-control-input" id="chk_${ mailVO.mlCd }" data-read="N" value="${ mailVO.mlCd }" name="chk">
										<label class="custom-control-label" for="chk_${ mailVO.mlCd }"></label>
									</div>
								</div>
								<i class="mdi mdi-email read" id="mlcd_${ mailVO.mlCd }" data-senrcp="${ mailVO.senRcp }" data-read="N" style="cursor: pointer;"></i>
								<c:if test="${ not empty mailVO.mailFileVOList }">
									<i class="mdi mdi-paperclip clip"></i>
								</c:if>
								<a class="email-title" style="cursor: default;">
									${ mailVO.memNm }
								</a>
							</div>
							<div class="email-content">
								<a href="/mail/detail?mlCd=${ mailVO.mlCd }" class="email-subject">
									<c:if test="${ mailVO.senRcp == 0 }">
										<span class="cate">[받은 메일함]</span>
									</c:if>
									<c:if test="${ mailVO.senRcp == 1 }">
										<span class="cate">[보낸 메일함]</span>
									</c:if>
									${ mailVO.mlTtl }
								</a>
								<div class="email-date">
									<c:if test="${ date == mlTm }">
										<fmt:formatDate value="${ mailVO.mlTm }" pattern="HH:mm"></fmt:formatDate>
									</c:if>
									<c:if test="${ date != mlTm }">
										<fmt:formatDate value="${ mailVO.mlTm }" pattern="MM-dd HH:mm"></fmt:formatDate>
									</c:if>
								</div>
							</div>
						</li>
					</c:if>
					<c:if test="${ mailVO.mlYn != 0 or mailVO.senRcp == 1 }">
						<li id="li_${ mailVO.mlCd }">
							<div class="email-sender-info">
								<div class="checkbox-wrapper-mail">
									<div class="custom-control custom-checkbox">
										<input type="checkbox" class="custom-control-input" id="chk_${ mailVO.mlCd }" data-read="Y" value="${ mailVO.mlCd }" name="chk">
										<label class="custom-control-label" for="chk_${ mailVO.mlCd }"></label>
									</div>
								</div>
								<i class="mdi mdi-email-open read" id="mlcd_${ mailVO.mlCd }" data-senrcp="${ mailVO.senRcp }" data-read="Y" style="cursor: pointer;"></i>
								<c:if test="${ not empty mailVO.mailFileVOList }">
									<i class="mdi mdi-paperclip clip"></i>
								</c:if>
								<a href="javascript: void(0);" class="email-title">
									${ mailVO.memNm }
								</a>
							</div>
							<div class="email-content">
								<a href="/mail/detail?mlCd=${ mailVO.mlCd }" class="email-subject">
									<c:if test="${ mailVO.senRcp == 0 }">
										<span class="cate">[받은 메일함]</span>
									</c:if>
									<c:if test="${ mailVO.senRcp == 1 }">
										<span class="cate">[보낸 메일함]</span>
									</c:if>
									${ mailVO.mlTtl }
								</a>
								<div class="email-date">
									<c:if test="${ date == mlTm }">
										<fmt:formatDate value="${ mailVO.mlTm }" pattern="HH:mm"></fmt:formatDate>
									</c:if>
									<c:if test="${ date != mlTm }">
										<fmt:formatDate value="${ mailVO.mlTm }" pattern="MM-dd HH:mm"></fmt:formatDate>
									</c:if>
								</div>
							</div>
						</li>
					</c:if>
				</c:forEach>
			</ul>
		</div>
		<!-- end .mt-4 -->
		
		<div style="text-align: center;">
		    <button type="button" class="btn btn-light" <c:if test='${ list.startPage lt 6 }'>disabled</c:if> onclick="location.href='/mail/mailAll?show=${ map.show }&cond=${ map.cond }&keyword=${ map.keyword }&currentPage=${ list.startPage - 5 }'"><i class="uil-angle-double-left"></i></button>
		    <button type="button" class="btn btn-light" <c:if test='${ list.startPage == list.currentPage }'>disabled</c:if> onclick="location.href='/mail/mailAll?show=${ map.show }&cond=${ map.cond }&keyword=${ map.keyword }&currentPage=${ list.currentPage - 1 }'"><i class="uil uil-angle-left"></i></button>
		         	<c:forEach var="pNo" begin="${ list.startPage }" end="${ list.endPage }">
		         		<c:if test="${ pNo == 0 }"><c:set var="pNo" value="1"></c:set></c:if>
			    <button type="button" class="btn btn-<c:if test="${ list.currentPage != pNo }">light</c:if><c:if test="${ list.currentPage == pNo }">primary</c:if>"
		    		 onclick="location.href='/mail/mailAll?show=${ map.show }&cond=${ map.cond }&keyword=${ map.keyword }&currentPage=${ pNo }'">
			    	${ pNo }
		    	</button>
			</c:forEach>
		    <button type="button" class="btn btn-light" <c:if test='${ list.endPage == list.currentPage }'>disabled</c:if> onclick="location.href='/mail/mailAll?show=${ map.show }&cond=${ map.cond }&keyword=${ map.keyword }&currentPage=${ list.currentPage + 1 }'"><i class="uil uil-angle-right"></i></button>
		    <button type="button" class="btn btn-light" <c:if test="${ list.endPage ge list.totalPages }">disabled</c:if> onclick="location.href='/mail/mailAll?show=${ map.show }&cond=${ map.cond }&keyword=${ map.keyword }&currentPage=${ list.startPage + 5 }'"><i class="uil-angle-double-right"></i></button>
		</div>
	</div>
</div>
<!-- end row-->